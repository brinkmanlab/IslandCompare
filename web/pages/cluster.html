<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>IslandCompare Cluster</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins -->
    <link rel="stylesheet" href="../dist/css/skins/skin-blue-light.min.css">
    <!-- Bootstrap Diag -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css">

    <link rel="stylesheet" href="../dist/css/linearplot.css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>

<body class="skin-blue-light">
<div class="wrapper">
    <!-- Main Header -->
    <header class="main-header">
    <!-- Logo -->
    <a href="#" class="logo">
        <span class="logo-mini"><b>IC</b></span>
        <span class="logo-lg"><b>IslandCompare</b></span>
    </a>
    <!-- Header Navbar -->
    <nav class="navbar navbar-static-top" role="navigation">
        <!-- Navbar Right Menu -->
        <div class="navbar-custom-menu">
            <ul class="nav navbar-nav">
                <!-- User Account Menu -->
                <li class="dropdown user user-menu">
                    <!-- Menu Toggle Button -->
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <!-- The user image in the navbar-->
                        <i class="fa fa-user"></i>
                        <!-- hidden-xs hides the username on small devices so only the image appears. -->
                        <span class="hidden-xs" id="profile-header">Profile</span>
                    </a>
                    <ul class="dropdown-menu">
                        <!-- Menu Body-->
                        <div class="btn-group-vertical btn-block">
                            <button type="button" class="btn btn-default btn-block">Settings</button>
                            <button type="button" class="btn btn-default btn-block" id="signout-button">
                                Sign out
                            </button>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>
    </header>

    <div id="content">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1 id="header"></h1>
            <ol class="breadcrumb">
                <li class="active"><a href="#"><i class="fa fa-dashboard"></i> Cluster</a></li>
            </ol>
        </section>
        <section class="content">
            <div class="box">
                <div class="box-header with-border">
                    <div class="clearfix">
                        <span id="legendTitle">Legend: </span>
                    </div>
                    <div class="legendBody clearfix">
                        <!--<svg id="homologousRegionLegend" height="10" width="10">-->
                            <!--<circle cx="5" cy="5" r="4" stroke-width="1"></circle>-->
                        <!--</svg>-->
                        <!--<span class="legendText">Homologous Region</span>-->
                        <svg id="amrLegend" height="10" width="10">
                            <circle cx="5" cy="5" r="4" stroke-width="1">
                                <title>AntiMicrobial Resistance Gene</title>
                            </circle>
                        </svg>
                        <span title="AntiMicrobial Resistance Gene" class="legendText">AMR Gene</span>
                        <svg id="genesLegend" height="10" width="10">
                            <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                        </svg>
                        <span class="legendText">Gene</span>
                        <svg id="tRNALegend" height="10" width="10">
                            <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                        </svg>
                        <span class="legendText">tRNA</span>
                        <svg id="rRNALegend" height="10" width="10">
                            <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                        </svg>
                        <span class="legendText">rRNA</span>
                    </div>
                </div>
                <div class="box-body">
                    <div id="visualizationBody"></div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 2.2.3 -->
<script src="../plugins/jQuery/jquery-2.2.3.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="../bootstrap/js/bootstrap.min.js"></script>
<!-- slimscroll -->
<script src="../plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="../plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="../dist/js/app.min.js"></script>
<!-- Load REST urls -->
<script src="../dist/js/islandcompare-rest-urls.js"></script>
<!-- Load auth -->
<script src="../dist/js/auth.js"></script>
<!-- Bootstrap Diag -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/js/bootstrap-dialog.min.js"></script>
<!-- D3 -->
<script src="../dist/js/d3.min.js"></script>

<script>
    $(document).ready(function(){
        requireLogin();
    });

    $("#signout-button").click(function(){
        deleteAuthenticationCookie();
        window.location.href="login.html"
    });

    function createClusterVisualization() {
        var SEQSTART = 115;
        var SVGPADDING = 30;
        var SEQPADDING = 25;
        var TEXTOFFSET = 15;
        var RECTHEIGHT = 10;

        var clusterDict = window.clusterDict;
        if (clusterDict === undefined) {
            clusterDict = JSON.parse(sessionStorage.getItem("clusterDict"));
        } else {
            // Store the clusterDict so it can be retrieved if the page is refreshed
            sessionStorage.setItem("clusterDict", JSON.stringify(clusterDict));
        }

        var cluster = clusterDict.cluster;
        $("#header").html("Cluster " + cluster);
        var color = clusterDict.color;
        var visWidth = $("#visualizationBody").width();
        var scale = getScale(clusterDict.sequences, visWidth - SVGPADDING - SEQSTART);

        // D3.js //
        var seq = d3.select("#visualizationBody")
            .selectAll("div")
            .data(clusterDict.sequences);

        var div = seq.enter().append("div");
        div.attr("class", function(seq) {
            return seq.name;
        });
        // Genome name
        div.append("p").append("b")
            .html(function(seq) {
                return seq.name;
            });

        var svg = div.append("svg")
            .attr("height", function(seq) {
                return seq.islands.length * SEQPADDING;
            })
            .attr("width", visWidth - SVGPADDING);

        var rectGroup = svg.selectAll("g")
            .data(function(seq) {
                return seq.islands;
            });

        rectGroup.enter().append("g");
        // Start and Stop text
        rectGroup.append("text")
            .text(function(d) {
                return d[0] + " - " + d[1];
            })
            .attr("y", function(d, i) {
                return (i * SEQPADDING) + TEXTOFFSET;
            });
        // The rect representing the genomic island
        rectGroup.append("rect")
            .attr("y", function(d, i) {
                return (i * SEQPADDING) + RECTHEIGHT / 2;
            })
            .attr("height", RECTHEIGHT)
            .attr("width", function(d) {
                return scale(Math.abs(d[1] - d[0]));
            })
            .attr("rx", 5)
            .attr("ry", 5)
            .attr("fill", color)
            .attr("transform", "translate(" + SEQSTART +",0)");
        // The genes
        rectGroup.append("g")
            .attr("class", "genes")
            .attr("transform", function(d, i) {
                return "translate(" + SEQSTART + "," + i * SEQPADDING + ")"
            })
            .selectAll("polygon")
            .data(function(island, i) {
                var genes;
                $.ajax({
                    url: genomesGenesUrl + island[2] + "?start=" + island[0] + "&end=" + island[1],
                    async: false,
                    headers: {
                        "Authorization": 'Token' + ' ' + getAuthenticationCookie()
                    },
                    success: function(data) {
                        // Change gene start and end positions to be start and end relative to GI start
                        for (var gene_i = 0; gene_i < data.genes.length; gene_i++) {
                            data.genes[gene_i].start -= island[0];
                            // If gene extends beyond the end of the GI it is cut short
                            data.genes[gene_i].end = Math.min(data.genes[gene_i].end - island[0], island[1] - island[0]);
                        }
                        genes = data.genes;
                    }
                });
                return genes;
            })
            .enter().append("polygon")
            .attr("points", function(gene) {
                return scale(gene.start) + "," + RECTHEIGHT/2 + "," +
                    scale(gene.end) + "," + RECTHEIGHT/2 + "," +
                    scale(gene.end) + "," + RECTHEIGHT + "," +
                    scale(gene.start) + "," + RECTHEIGHT;
            })
            .attr("transform", function(gene) {
                // Move -1 strand genes down
                if (gene.strand === -1) {
                    return "translate(0," + RECTHEIGHT / 2 + ")"
                }
            })
            .attr("class", function(gene) {
                return gene.type;
            })
            .append("title")
                .text(function (gene) {
                    var hover = "";
                    if(gene.gene) {
                        hover = hover.concat("Gene name: " + gene.gene + "\n");
                    }
                    if(gene.locus_tag) {
                        hover = hover.concat("Locus tag: " + gene.locus_tag + "\n");
                    }
                    if(gene.product) {
                        hover = hover.concat("Product: " + gene.product)
                    }
                    return hover;
                });
        // The AMR genes
        rectGroup.append("g").attr("class", "amrs")
            .attr("transform", function(d, i) {
                return "translate(" + SEQSTART + "," + i * SEQPADDING + ")"
            })
            .each(function(island, i) {
                var start = island[0];
                var end = island[1];
                var seq = island[2];
                var index = clusterDict.sequences.findIndex(i => i.id === seq);
                var amrs = clusterDict.sequences[index].amr;
                for (var i = 0; i < amrs.length; i++) {
                    if (amrs[i].start < end && amrs[i].end > start) {
                        var amr_start = scale(amrs[i].start - start);
                        var amr_end = scale(amrs[i].end - start);
                        var neg_strand = (amrs[i].strand === "-");
                        d3.select(this).append("polygon")
                            .attr("points", function() {
                                // Returns a trapezoid shape.
                                // Shape depends on whether it is on negative strand and
                                // whether it is within the boundaries of the GI
                                var points = "";
                                if (neg_strand) {
                                    if (amrs[i].start < start) {
                                        points += "0,0,0," + RECTHEIGHT / 2 + ",";
                                    } else {
                                        points += amr_start + ",0," +
                                            (amr_start + RECTHEIGHT / 2) + "," + RECTHEIGHT / 2 + ",";
                                    }
                                    if (amrs[i].end > end) {
                                        points += scale(end - start) + "," + RECTHEIGHT / 2 +
                                            "," + scale(end - start) + ",0";
                                    } else {
                                        points += (amr_end - RECTHEIGHT / 2) + "," + RECTHEIGHT / 2 + "," +
                                                amr_end + ",0";
                                    }
                                } else {
                                    if (amrs[i].start < start) {
                                        points += "0,0,0," + RECTHEIGHT / 2 + ",";
                                    } else {
                                        points += (amr_start + RECTHEIGHT / 2) + ",0," + amr_start + "," + RECTHEIGHT / 2 + ",";
                                    }
                                    if (amrs[i].end > end) {
                                        points += scale(end - start) + "," + RECTHEIGHT / 2 +
                                            "," + scale(end - start) + ",0";
                                    } else {
                                        points += amr_end + "," + RECTHEIGHT / 2 + "," +
                                            (amr_end - RECTHEIGHT / 2) + ",0";
                                    }
                                }
                                return points;
                            })
                            .attr("transform", function() {
                                // Move negative strand AMR genes to the underside of the GI
                                if (neg_strand) {
                                    return "translate(0, "+ 3 / 2 * RECTHEIGHT +")"
                                }
                            });
                    }
                }
        });
    }

    function getScale(sequences, containerWidth) {
        var lengths = [];
        for (var seqIndex = 0; seqIndex < sequences.length; seqIndex++) {
            var islands = sequences[seqIndex].islands;
            for (var islandIndex = 0; islandIndex < islands.length; islandIndex++) {
                lengths.push(Math.abs(islands[islandIndex][1] - islands[islandIndex][0]));
            }
        }
        var max = Math.max.apply(null, lengths);
        return d3.scale.linear()
            .domain([0,max])
            .range([0,containerWidth])
            .clamp(true);
    }

    $(window).on("load", createClusterVisualization);
</script>
<!--Force content to fill screen-->
<style>
    html, body, .wrapper {
        height: 100% !important;
    }
</style>
</body>
