<!-- Load Required Scripts -->
<script src="../dist/js/d3.min.js"></script>
<script src="../dist/js/d3.phylogram.js"></script>
<script src="../dist/js/newick.js"></script>
<script src="../dist/js/genomecomparevis.js"></script>
<link rel="stylesheet" href="../dist/css/linearplot.css" />


<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="row">
        <div class="col-xs-3"></div>
        <div hidden id="warning-box" class="alert alert-warning alert-dismissable col-xs-6 text-center"></div>
        <div class="col-xs-3"></div>
    </div>
    <h1>
        Results
    </h1>
    <ol class="breadcrumb">
        <li class="active"><a href="#"><i class="fa fa-bar-chart"></i> Results</a></li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <div class="box">
        <div class="box-header with-border">
            <div class="controlRow row">
                <div class="col-xs-5">
                    <div class="clearfix">
                        <span id="#controlTitle">Controls: </span>
                    </div>
                    <div id="btn-div" class="clearfix btn-group btn-group-sm">
                        <button id="toggleBranchLength" class="btn btn-primary btn-flat">Toggle Branches</button>
                        <button id="resetTree" class="btn btn-primary btn-flat">Reset Tree</button>
                        <button id="resetGIs" class="btn btn-primary btn-flat clusterButton" style="display: none;">
                            Reset GIs
                        </button>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary btn-flat dropdown-toggle" data-toggle="dropdown">
                                Save image <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" id="saveSvg" href="#">svg</a></li>
                                <li><a class="dropdown-item" id="savePng" href="#">png</a></li>
                            </ul>
                        </div>
                        <button id="printerColors" class="btn btn-primary btn-flat" style="clear: left; margin-left: 0px;">Toggle Colour</button>
                        <button id="resetRange" class="btn btn-primary btn-flat">Reset Zoom</button>
                        <button id="zoomCluster" class="btn btn-primary btn-flat clusterButton" style="display: none;">
                            Zoom to Cluster
                        </button>
                    </div>
                </div>
                <div class="col-xs-2 GIColour">
                    <div class="clearfix">
                        <span id="GITitle">Colour GIs by: </span>
                    </div>
                    <div class="GIColourBody">
                        <div class="clearfix">
                            <label>
                                <input type="radio" name="GIColour" value="similarity" checked/>Similarity
                            </label>
                            <label id="predictorButton">
                                <input type="radio" name="GIColour" value="predictor" />Predictor
                            </label>
                        </div>
                        <div class="clearfix">
                            <span id="sigiToggle">
                                <label>
                                    <input type="checkbox" name="sigi" value="sigi" id="sigi-box" checked disabled>Sigi-HMM
                                </label>
                            </span>
                            <span id="islandpathToggle">
                                <label>
                                    <input type="checkbox" name="islandpath" value="islandpath" id="islandpath-box" checked disabled>IslandPath
                                </label>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-xs-5">
                    <div class="clearfix">
                        <span id="legendTitle">Legend: </span>
                    </div>
                    <div class="legendBody clearfix">
                        <svg id="homologousRegionLegend" height="10" width="10">
                            <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                        </svg>
                        <span class="legendText">Homologous Region</span>
                        <svg id="amrLegend" height="10" width="10">
                            <polygon points="3,0,7,0,10,10,0,10"><title>AntiMicrobial Resistance Gene</title></polygon>
                        </svg>
                        <span title="AntiMicrobial Resistance Genes" class="legendText">AMR Gene</span>
                        <span class="loadingGenes" hidden>
                            <i class='fa fa-spinner fa-spin '></i> Loading Genes
                        </span>
                        <span hidden class="genesLegend-toggle">
                            <svg id="genesLegend" height="10" width="10">
                                <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                            </svg>
                            <span class="legendText">Gene</span>
                            <svg id="tRNALegend" height="10" width="10">
                                <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                            </svg>
                            <span class="legendText">tRNA</span>
                            <svg id="rRNALegend" height="10" width="10">
                                <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                            </svg>
                            <span class="legendText">rRNA</span>
                        </span>
                    </div>
                    <div class="predictorLegend clearfix" hidden>
                        <span id="sigiLegend" class="legendText">
                            <svg height="10" width="10">
                                <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                            </svg>
                            Sigi-HMM Genomic Island
                        </span>
                        <span id="islandpathLegend" class="legendText">
                            <svg height="10" width="10">
                                <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                            </svg>
                            IslandPath Genomic Island
                        </span>

                    </div>
                    <div id="clusterLegend" class="clearfix" hidden>
                        <svg height="10" width="10">
                            <circle cx="5" cy="5" r="4" stroke-width="1"></circle>
                        </svg>
                        <span id="clusterLegendSpan" class="legendText"></span>
                    </div>
                </div>
                <!--
                --Currently Not used
                <div class="controlSide">
                    <button id="toggleControls">(<<)</button>
                </div>
                -->
            </div>
        </div>
        <!-- /.box-header -->
        <div class="box-body">
            <div id="visualization-body"></div>
            <svg>
                <filter id="shadow" x="-5" y="-5" width="200" height="200">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="5" />
                    <feColorMatrix result="matrixOut" in="offOut" type="matrix"
                        values="0   0   0   0   0
                                0   0   0   0   0
                                0   0   0   0   0
                                0   0   0   2   0" />
                    <feMerge>
                        <feMergeNode/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </svg>
        </div>
        <!-- /.box-body -->
    </div>
    <!-- /.box -->
</section>
<!-- /.content -->

<script>
    function createVisualization(url){
        var container = new MultiVis("#visualization-body");
        $.ajax({
            url: url,
            beforeSend: function (request) {
                request.setRequestHeader("Authorization", 'Token'+' '+getAuthenticationCookie());
            },
            success: function(data) {
                var sigiFails = 0;
                var islandPathFails = 0;
                if (Object.keys(data["failed_components"]).length) {
                    var warning_message = "<h4>Warning:</h4>";
                    if ("sigi" in data["failed_components"]) {
                        warning_message = warning_message.concat("<p>Sigi-HMM Failed ");
                        sigiFails = data["failed_components"]["sigi"].length;
                        if (sigiFails === 1) {
                            warning_message = warning_message.concat("for genome " + data["failed_components"]["sigi"][0]);
                        } else {
                            warning_message = warning_message.concat("for genomes ");
                            var failed_genomes = data["failed_components"]["sigi"];
                            warning_message = warning_message.concat(failed_genomes.join(", "));
                        }
                        warning_message = warning_message.concat("</p>");
                    }
                    if ("islandpath" in data["failed_components"]) {
                        warning_message = warning_message.concat("<p>IslandPath Failed ");
                        islandPathFails = data["failed_components"]["islandpath"].length;
                        if (islandPathFails === 1) {
                            warning_message = warning_message.concat("for genome " + data["failed_components"]["islandpath"][0]);
                        } else {
                            warning_message = warning_message.concat("for genomes ");
                            var failed_genomes = data["failed_components"]["islandpath"];
                            warning_message = warning_message.concat(failed_genomes.join(", "));
                        }
                        warning_message = warning_message.concat("</p>");
                    }
                    $("#warning-box").html(warning_message)
                        .show();
                }

                // Add the newick data to generate a tree
                container.newickData = Newick.parse(data["newick"]);
                // Set the root of the tree
                container.newickRoot = container.newickData;

                // Traverse tree to find sequence id order
                var treeOrder = container.traverseTreeForOrder(container.newickRoot);

                // Hide irrelevant legends and controls
                if (!data["cluster_gis"]) {
                    // No clustering occurred - predictors failed for every genome or GIs were provided with colors
                    // GI legend in unnecessary
                    $(".GIColour").children().hide();
                }
                else if (data["cluster_gis"] === "user") {
                    // GIs were provided so coloring by predictor does not apply
                    $("#islandpathToggle").hide();
                    $("#sigiToggle").hide();
                    $("#islandpathLegend").remove();
                    $("#sigiLegend").remove();
                    $("#predictorButton").hide();
                }
                else {
                    if (islandPathFails === treeOrder.length) {
                        // IslandPath failed for all genomes so legend and toggle are unnecessary
                        $("#islandpathToggle").hide();
                        $("#islandpathLegend").remove();
                    }
                    if (sigiFails === treeOrder.length) {
                        // Sigi-HMM failed for all genomes so legend and toggle are unnecessary
                        $("#sigiToggle").hide();
                        $("#sigiLegend").remove();
                    }
                }

                // Add Genomes to Visualization
                for (var i = 0; i < treeOrder.length; i++) {
                    var genomeId = treeOrder[i];
                    var currentSeq = container.backbone.addSequence(
                        genomeId,
                        data["genomes"][genomeId]["length"],
                        data["genomes"][genomeId]["name"],
                        data["genomes"][genomeId]["name"]
                    );

                    currentSeq.addAMR(data["genomes"][genomeId]["amr_genes"]);
                  
                    if ("user" in data["genomes"][genomeId]["genomic_islands"]){
                        currentSeq.addGI("user", data["genomes"][genomeId]["genomic_islands"]["user"]);
                    }
                    else {
                        if ("islandpath" in data["genomes"][genomeId]["genomic_islands"]) {
                            currentSeq.addGI("islandpath", data["genomes"][genomeId]["genomic_islands"]["islandpath"]);
                        }
                        if ("sigi" in data["genomes"][genomeId]["genomic_islands"]) {
                            currentSeq.addGI("sigi", data["genomes"][genomeId]["genomic_islands"]["sigi"]);
                        }
                        if ("merge" in data["genomes"][genomeId]["genomic_islands"]) {
                            currentSeq.addGI("merged", data["genomes"][genomeId]["genomic_islands"]["merge"]);
                        }
                    }

                    // at this scale, individual scaling for sequences may not be usable...so used fixed scale
                    currentSeq.updateScale(0, container.getLargestSequenceSize(), container.getLargestSequenceSize());
                }

                // Add homologous regions to Visualization
                for (var i = 0; i < data["alignment"].length; i++){
                    for (var j = 0; j < data["alignment"][i].length; j++){
                        container.backbone.addHomologousRegion(
                            treeOrder[i],
                            data["alignment"][i][j][0],
                            data["alignment"][i][j][1],
                            data["alignment"][i][j][2],
                            data["alignment"][i][j][3]
                        )
                    }
                }

                // render the graph
                container.render();
            }
        });

        var isPrinterColors = false;

        // Add listeners to button controls
        $(document).ready(function() {
            //Button resets any tree zooming that was done
            $("#resetTree").on("click", this, function () {
                container.resetAndRenderGraph();
            });
            //Button resets the range of the linear plot to (0,maxSize)
            $("#resetRange").on("click", this, function () {
                container.resetAndRenderRange();
            });
            //Button toggles if show true branch lengths or not
            $("#toggleBranchLength").on("click", this, function () {
                container.toggleTrueBranchLengths();
                container.transition();
            });
            //Button toggles printer colors on the linear plot
            $("#printerColors").on("click", this, function () {
                container.togglePrinterColors();
                container.render();
                // Update the Legend Colors
                isPrinterColors = !isPrinterColors;
                if (isPrinterColors) {
                    $("#genomicIslandLegend").attr("class", "#genomicIslandsLegend print");
                    $("#genesLegend").attr("class", "#genesLegend print");
                    $("#tRNALegend").attr("class", "#tRNALegend print");
                    $("#rRNALegend").attr("class", "#rRNALegend print");
                    $("#genomeLegend").attr("class", "#genomeLegend print");
                    $("#amrLegend").attr("class", "#amrLegend print");
                }
                else {
                    $("#genomicIslandLegend").attr("class", "#genomicIslandsLegend");
                    $("#genesLegend").attr("class", "#genesLegend");
                    $("#tRNALegend").attr("class", "#tRNALegend");
                    $("#rRNALegend").attr("class", "#rRNALegend");
                    $("#genomeLegend").attr("class", "#genomeLegend");
                    $("#amrLegend").attr("class", "#amrLegend");
                }
            });
            $("#saveSvg").on("click", this, function() {
                container.saveImage("svg");
            });
            $("#savePng").on("click", this, function() {
                container.saveImage("png");
            });
            $("#resetGIs").on("click", this, function() {
                container.toggleClusterView(container.cluster, null);
            });
            $("#zoomCluster").on("click", this, function() {
                container.zoomCluster();
            });
            // Changes to sigi/islandpath checkboxes will hide/show corresponding GIs
            $(".GIColourBody :checkbox").change(container.predictorToggle);
            // Changes to GI colour method will hide/show the merged GI set and enable/disable the predictor checkboxes
            $("input[name=GIColour]").change(container.GIColourToggle);
            // Set all buttons to have the same width
            var buttons = $("#btn-div").children();
            buttons.width(buttons.width());
        });
    }
</script>