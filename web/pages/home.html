<!-- DataTables -->
<link rel="stylesheet" href="../plugins/datatables/dataTables.bootstrap.css">
<!-- Dropzone -->
<link rel="stylesheet" href="../dist/css/dropzone.css">

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Home
    </h1>
    <ol class="breadcrumb">
        <li class="active"><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-xs-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Recent Jobs</h3>
                </div><!-- /.box-header -->
                <div class="box-body" id="recent-jobs-body">

                </div><!-- /.box-body -->
            </div><!-- /.box -->
        </div>
        <!-- ./col-xs-6 -->
        <div class="col-xs-6">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Upload Genomes</h3>
                </div>
                <div class="box-body">
                    <form id="genomeUploadForm">
                        Drop gbk or embl files here or click to upload.
                        <div id="genomePreviewBox" class="dropzone-previews"></div>
                    </form>
                </div>
                </div>
            </div>
        </div>
        <!-- ./col-xs-6 -->
    </div>
    <!-- ./row -->
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Uploaded Genomes</h3>
                    <button class="btn btn-primary btn-flat pull-right" id="genome-delete">
                        Delete Selected Genomes
                    </button>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <table id="uploaded-genomes" class="table table-bordered table-hover table-striped" width="100%">
                        <thead>
                        <tr>
                            <th>Genome</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <!-- /.box-body -->
            </div>
            <!-- /.box -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Run Analysis</h3>
                </div><!-- /.box-header -->
                <div class="box-body">
                    <!-- form start -->
                    <form role="form" id="run-analysis-form">
                        <div class="row">
                            <div class="col-xs-6">
                                <div class="form-group">
                                    <label for="analysis-name-field">Analysis Name</label>
                                    <input type="text" class="form-control" id="analysis-name-field" name="name">
                                </div>
                            </div>
                            <div class="col-xs-6">
                                <div class="form-group">
                                    <label for="analysis-newick-field">Newick File (Optional)</label>
                                    <input type="file" class="form-control" id="analysis-newick-field" name="newick">
                                </div>
                                <div class="form-group">
                                    <label for="analysis-gi-field">Genomic Island File (Optional)</label>
                                    <input type="file" class="form-control" id="analysis-gi-field" name="gi">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="selected-genomes-field">Selected Genomes</label>
                            <select multiple="" class="form-control" id="selected-genomes-field"></select>
                        </div>
                        <button type="submit" class="btn btn-block btn-primary btn-flat" id="analysis-submit">
                            Start Analysis
                        </button>
                    </form>
                </div><!-- /.box-body -->
            </div><!-- /.box -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
</section>
<!-- /.content -->



<!-- DataTables -->
<script src="../plugins/datatables/datatables.select.min.js"></script>
<script src="../plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- DropZone -->
<script src="../plugins/dropzone/dropzone.js"></script>
<!-- Urls -->
<script src="../dist/js/islandcompare-rest-urls.js"></script>

<!-- page script -->
<script>
    $(document).ready(function () {
        var genomesTable = $("#uploaded-genomes").DataTable({
            ajax: {
                url: genomesUrl,
                dataSrc: '',
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", 'Token'+' '+getAuthenticationCookie());
                }
            },
            columns: [
                { data: 'name' }
            ],
            select: {
                style: 'multi'
            },
            rowId: 'id'
        });

        genomesTable.on( 'select', function (e, dt, type, indexes) {
            var data = genomesTable.rows(indexes).data()[0];
            $("#selected-genomes-field").append($('<option>', {
                value: data['id'],
                text : data['name']
            }));
            var selectList = $('#selected-genomes-field option').sort(function(a, b){
                return a.value-b.value;
            });
            $('#selected-genomes-field').html(selectList);
        } );

        genomesTable.on( 'deselect', function (e, dt, type, indexes) {
            var data = genomesTable.rows(indexes).data()[0];
            $('#selected-genomes-field option[value=' + data['id'] + ']').remove();
        } );

        $("#selected-genomes-field").dblclick(function (){
            var row = genomesTable.row('#'+$(this).val());
            row.deselect();
        });

        $("#analysis-submit").click(function(e){
            e.preventDefault();

            var data = $('#run-analysis-form').serializeArray();
            var payload = new FormData();
            payload.append("name", data[0]['value']);
            var selected_genomes = $("select#selected-genomes-field option").map(function() {return $(this).val();}).get();
            for (var i = 0; i < selected_genomes.length; i++) {
                payload.append('genomes', selected_genomes[i]);
            }
            if ($('#analysis-newick-field').get(0).files.length > 0){
                payload.append("newick", $('#analysis-newick-field').get(0).files[0]);
            }

            if ($('#analysis-gi-field').get(0).files.length > 0){
                payload.append("gi", $('#analysis-gi-field').get(0).files[0]);
            }

            $.ajax({
                type: "POST",
                url: analysisRunUrl,
                data: payload,
                headers: {
                    "Authorization": 'Token'+' '+getAuthenticationCookie()
                },
                success: function() {
                    $('#run-analysis-form').trigger("reset");
                    $("#selected-genomes-field option").remove();
                    genomesTable.rows( { selected: true } ).deselect();
                    BootstrapDialog.alert("Analysis has been submitted.");
                },
                error: function(message) {
                    BootstrapDialog.warning(message.responseText);
                },
                cache: false,
                contentType: false,
                processData: false,
            });

            return false;
        });

        // DELETE on the url of each selected genome
        // Genome is then removed from table and from the selected genomes area
        $("#genome-delete").click(function() {
            var selected_genomes = $("select#selected-genomes-field option").map(function () {
                return $(this).val();
            }).get();
            for (var i = 0; i < selected_genomes.length; i++) {
                $.ajax({
                    type: "DELETE",
                    url: genomesUpdateUrl + selected_genomes[i],
                    headers: {
                        "Authorization": 'Token' + ' ' + getAuthenticationCookie()
                    },
                    success: function() {
                        genomesTable.row('.selected').remove().draw();
                        $("#selected-genomes-field option").remove();
                    },
                    error: function(message) {
                        BootstrapDialog.warning(message.responseText);
                    }
                });
            }
        });

        $.ajax({
            type: "GET",
            url: analysisUrl,
            data: {
                "num": 3
            },
            headers: {
                "Authorization": 'Token' + ' ' + getAuthenticationCookie()
            },
            success: function(data){
                ReloadRecentAnalysisTable(data);
            }
        });


    });

    $("form#genomeUploadForm").dropzone({
        url: genomesUploadUrl,
        paramName: "genomes",
        previewsContainer:"#genomePreviewBox",
        acceptedFiles:".gb,.gbff,.gbk,.genbank",
        headers: {
            "Cache-Control": "",
            "Authorization": 'Token'+' '+getAuthenticationCookie()
        },
        // If upload was successful, another GET call is made to find the id of the last genome - the one that was just
        // uploaded. This id is needed to add a row for the new genome into the DataTable.
        // There must be a better way to do this. While the data returned by the upload (up_data) contains the
        // file name (up_data.name), it doesn't seem to contain the id.
        success: function(up_data){
            var new_row_id;
            $.ajax({
                type: "GET",
                url: genomesUrl,
                headers: {
                    "Authorization": 'Token' + ' ' + getAuthenticationCookie()
                },
                success: function(data) {
                    var new_row_id = data[data.length - 1].id;
                    var genomesTable = $("#uploaded-genomes").DataTable();
                    genomesTable.row.add({ name: up_data.name, id: new_row_id }).draw();
                }
            });
        }
    });

    function ReloadRecentAnalysisTable(data) {
        var table = '<ul class ="list-group">';

        for (var i = 0; i < data.length; i++){
            table = table.concat(
                '<li class="list-group-item"><a href="#" class="recent-job-item" data-jobid="' +
                data[i]["id"] + '"><h5>' + data[i]["name"] + '</h5>'
            );

            var success_count = 0;
            var state = 0; //1 = Success, Fail = -1, 0 = Pending
            for (var j in Object.keys(data[i]["analysiscomponent_set"])) {
                var status = data[i]["analysiscomponent_set"][Object.keys(data[i]["analysiscomponent_set"])[j]]["status"];
                if (status === "FAILURE"){
                    //Fail
                    state = -1;
                }
                else if (status === "SUCCESS"){
                    success_count += 1;
                }
                else{
                    //Assume pending, do nothing
                }
            }

            if (success_count === Object.keys(data[i]["analysiscomponent_set"]).length){
                table = table.concat(
                    '<div class="progress sm">' +
                        '<div class="progress-bar progress-bar-success progress-bar-striped active" style="width: 100%"></div>' +
                    '</div>'
                )
            }
            else if (state === -1){
                var percent = (success_count / Object.keys(data[i]["analysiscomponent_set"]).length) * 100;
                table = table.concat(
                    '<div class="progress sm">' +
                    '<div class="progress-bar progress-bar-danger progress-bar-striped active" style="width: ' + percent + '%"></div>' +
                    '</div>'
                )
            }
            else{
                var percent = (success_count / Object.keys(data[i]["analysiscomponent_set"]).length) * 100;
                table = table.concat(
                    '<div class="progress sm">' +
                    '<div class="progress-bar progress-bar-info progress-bar-striped active" style="width: ' + percent + '%"></div>' +
                    '</div>'
                )
            }
            table = table.concat('</a></li>');
        }
        table = table.concat('</ul>');
        $("#recent-jobs-body").html(table);

        loadRecentJobFunction();
    }

    function loadRecentJobFunction() {
        $(".recent-job-item").click(function () {
            var jobid = $(this).data()["jobid"];
            $("#content").load("result.html",
                null,
                function(){
                    createVisualization(analysisResultsUrl + jobid);
                }
            );
        });
    }

</script>
</body>
</html>
